<% layout("/layouts/boilerplate") %>

<div class="container my-5">

  <!-- ================= LISTING DETAILS ================= -->
  <div class="card shadow-lg border-0 p-4 mb-5">
    <div class="row g-4 align-items-start">

      <!-- Image -->
      <div class="col-md-6">
        <div class="rounded overflow-hidden" style="height: 340px;">
          <img
            src="<%= listing.image?.url || 'https://via.placeholder.com/600x400' %>"
            alt="listing image"
            class="w-100 h-100"
            style="object-fit: cover;"
          >
        </div>
      </div>

      <!-- Info -->
      <div class="col-md-6">

        <h3 class="fw-bold mb-2"><%= listing.title %></h3>

        <p class="fs-4 fw-semibold text-success mb-3">
          ‚Çπ
          <%= listing.price != null 
                ? Number(listing.price).toLocaleString("en-IN") 
                : "N/A" %>
          <span class="fs-6 text-muted">/ night</span>
        </p>

        <p class="text-muted mb-4">
          <%= listing.description %>
        </p>

        <ul class="list-group list-group-flush mb-4">
          <li class="list-group-item px-0">
            üìç <strong>Location:</strong> <%= listing.location %>
          </li>
          <li class="list-group-item px-0">
            üåç <strong>Country:</strong> <%= listing.country %>
          </li>
        </ul>

        <div class="d-flex gap-3">
          <a href="/listings/<%= listing._id %>/edit"
             class="btn btn-outline-dark">
            ‚úèÔ∏è Edit
          </a>

          <form method="POST"
                action="/listings/<%= listing._id %>?_method=DELETE">
            <button class="btn btn-danger">
              üóë Delete
            </button>
          </form>
        </div>

      </div>
    </div>
  </div>

  <!-- ================= REVIEW FORM ================= -->
  <div class="card shadow-sm border-0 mb-5">
    <div class="card-body p-4">

      <h4 class="fw-bold mb-1">Write a Review</h4>
      <p class="text-muted mb-4">
        Share your experience to help others
      </p>

      <form class="needs-validation"
            action="/listings/<%= listing._id %>/reviews"
            method="POST"
            novalidate>

        <!-- Rating -->
        <div class="mb-4">
          <label class="form-label fw-semibold d-block mb-2">
            Your Rating
          </label>

          <div class="star-rating mb-1">
            <% for (let i = 5; i >= 1; i--) { %>
              <input
                type="radio"
                id="star<%= i %>"
                name="review[rating]"
                value="<%= i %>"
                required
              >
              <label for="star<%= i %>">‚òÖ</label>
            <% } %>
          </div>

          <div class="invalid-feedback d-block">
            Please select a rating.
          </div>
        </div>

        <!-- Comment -->
        <div class="mb-4">
          <label class="form-label fw-semibold">
            Your Review
          </label>

          <textarea
            class="form-control"
            name="review[comment]"
            rows="4"
            placeholder="What did you like or dislike?"
            required
          ></textarea>

          <div class="invalid-feedback">
            Please write a short review.
          </div>
        </div>

        <div class="text-end">
          <button class="btn btn-dark px-4">
            Submit Review
          </button>
        </div>

      </form>
    </div>
  </div>

  <!-- ================= REVIEWS LIST ================= -->
  <div class="card shadow-sm border-0">
    <div class="card-body p-4">

      <h4 class="fw-bold mb-3">
        Reviews
        <span class="text-muted fs-6">
          (<%= listing.reviews.length %>)
        </span>
      </h4>

      <% if (listing.reviews.length === 0) { %>
        <p class="text-muted">
          No reviews yet. Be the first to review!
        </p>
      <% } %>

     <% for (let review of listing.reviews) { %>
  <div class="border rounded p-3 mb-3 d-flex justify-content-between align-items-start">

    <div>
      <!-- Stars -->
      <div class="text-warning fs-5 mb-1">
        <% for (let i = 0; i < review.rating; i++) { %>‚òÖ<% } %>
        <% for (let i = review.rating; i < 5; i++) { %>‚òÜ<% } %>
      </div>

      <!-- Comment -->
      <p class="mb-0">
        <%= review.comment %>
      </p>
    </div>

    <!-- DELETE BUTTON -->
    <form
      action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE"
      method="POST"
    >
      <button class="btn btn-sm btn-outline-danger">
        üóë
      </button>
    </form>

  </div>
<% } %>


    </div>
  </div>

</div>
